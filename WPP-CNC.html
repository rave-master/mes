<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WPP Permit Dashboard - CNC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .dashboard-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .search-box {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .filter-btn {
      transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
      transform: scale(1.05);
    }
    
    .status-active {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .status-expiring {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .status-expired {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .animate-fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .data-row {
      transition: all 0.2s ease;
    }
    
    .data-row:hover {
      background-color: #f8fafc;
      transform: scale(1.01);
    }
    
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-amber-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 bg-gradient-to-r from-amber-600 to-orange-700 rounded-lg flex items-center justify-center">
            <i class="fas fa-industry text-white text-lg"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">WPP Permit Dashboard</h1>
            <p class="text-sm text-gray-600">CENRO New Corella Management System</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-sm text-gray-600">Last Updated</p>
            <p class="text-sm font-semibold text-gray-900" id="lastUpdated"></p>
          </div>
          <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-gray-600"></i>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8 animate-fade-in">
      <div class="stat-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Permits</p>
            <p class="text-3xl font-bold text-gray-900" id="totalLicenses">6</p>
          </div>
          <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-certificate text-amber-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-amber-600 font-medium" id="totalLicensesChange">
            <i class="fas fa-arrow-up"></i> 67% Active
          </span>
        </div>
      </div>

      <div class="stat-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Active Permits</p>
            <p class="text-3xl font-bold text-green-600" id="activeLicenses">4</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600" id="activeLicensesText">Currently valid</span>
        </div>
      </div>

      <div class="stat-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Expiring Soon</p>
            <p class="text-3xl font-bold text-yellow-600" id="expiringSoon">1</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600">Next 1 year</span>
        </div>
      </div>

      <div class="stat-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Expired</p>
            <p class="text-3xl font-bold text-red-600" id="expiredLicenses">1</p>
          </div>
          <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-times-circle text-red-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600">Need renewal</span>
        </div>
      </div>

      <div class="stat-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Establishments</p>
            <p class="text-3xl font-bold text-blue-600" id="totalHolders">6</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-users text-blue-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-600">Registered establishments</span>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8 animate-fade-in">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
        <div class="flex flex-wrap gap-3">
          <button class="filter-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 ring-2 ring-blue-300" onclick="filterTable('all')">
            <i class="fas fa-list mr-2"></i>All Permits
          </button>
          <button class="filter-btn px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700" onclick="filterTable('active')">
            <i class="fas fa-check mr-2"></i>Active
          </button>
          <button class="filter-btn px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700" onclick="filterTable('expiring-soon')">
            <i class="fas fa-clock mr-2"></i>Expiring Soon
          </button>
          <button class="filter-btn px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700" onclick="filterTable('expired')">
            <i class="fas fa-times mr-2"></i>Expired
          </button>
          <button class="filter-btn px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-medium hover:bg-gray-700" onclick="exportData()">
            <i class="fas fa-download mr-2"></i>Export
          </button>
        </div>
        <div class="relative">
          <input type="text" id="searchInput" placeholder="Search WPP permits..." 
                 class="search-box pl-10 pr-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-500 focus:outline-none w-full lg:w-80">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-container animate-fade-in">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-table mr-2 text-amber-600"></i>
          Wood Processing Permit Registry
        </h3>
        <p class="text-sm text-gray-600 mt-1">Complete list of wood processing permits and establishments</p>
      </div>
      
      <div class="overflow-x-auto" id="tableContainer">
        <table class="w-full" id="licenseTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-industry mr-2"></i>Establishment
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-map-marker-alt mr-2"></i>Location/Address
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-hashtag mr-2"></i>Permit Number
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-calendar-check mr-2"></i>Date Approved
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-calendar-times mr-2"></i>Expiry Date
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-user-tie mr-2"></i>Owner/Representative
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-user-check mr-2"></i>Data Provider
              </th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <i class="fas fa-info-circle mr-2"></i>Status
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
            <!-- Data will be loaded from Google Sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-sm text-gray-600">
      <p>Data provided by Carmalyn C. Nesperos / RPS-LPU • CENRO New Corella</p>
      <p class="mt-2">© 2024 Wood Processing Permit Management System</p>
    </div>
  </div>

  <script>
    let allData = [];
    let currentFilter = 'all';

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      updateLastUpdated();
      initializeSearch();
      loadDataFromGoogleSheets();
    });

    function updateLastUpdated() {
      const now = new Date();
      const formatted = now.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('lastUpdated').textContent = formatted;
    }

    async function loadDataFromGoogleSheets() {
      try {
        // WPP Google Sheets URL
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSwGBYZbKiE-Z_YNKnYz59B7uS_nmxFJd85mRrPFK03W_B0HOADgr2D5q7mT8Kt17-xFhrIiSk8eq0H/pub?gid=0&single=true&output=csv', {
          method: 'GET',
          headers: {
            'Accept': 'text/csv,text/plain,*/*'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('CSV Data received:', csvText.substring(0, 500));
        
        // Parse CSV
        const lines = csvText.split('\n').filter(line => line.trim());
        console.log('Number of lines:', lines.length);
        
        if (lines.length < 2) {
          throw new Error('No data found in the spreadsheet');
        }
        
        const headers = parseCSVLine(lines[0]);
        console.log('Headers:', headers);
        
        allData = [];
        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i]);
          
          if (values.length >= 1 && values[0] && values[0].trim()) {
            allData.push({
              establishment: values[0] || '',
              location: values[1] || '',
              permitNumber: values[2] || '',
              dateApproved: values[3] || '',
              expiryDate: values[4] || '',
              owner: values[5] || '',
              dataProvider: values[6] || ''
            });
          }
        }
        
        console.log('Processed data:', allData);
        
        if (allData.length > 0) {
          populateTable();
          calculateStats();
        } else {
          console.log('No valid data found, keeping sample data');
        }
        
      } catch (error) {
        console.error('Error loading data from Google Sheets:', error);
        console.log('Using sample data as fallback');
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    function getLicenseStatus(expiryDate) {
      if (!expiryDate) return { status: 'Unknown', class: 'status-expired' };
      
      const expiry = new Date(expiryDate);
      const today = new Date();
      const oneYearFromNow = new Date();
      oneYearFromNow.setFullYear(today.getFullYear() + 1);
      
      if (expiry < today) {
        return { status: 'Expired', class: 'status-expired' };
      } else if (expiry <= oneYearFromNow) {
        return { status: 'Expiring Soon', class: 'status-expiring' };
      } else {
        return { status: 'Active', class: 'status-active' };
      }
    }

    function populateTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      allData.forEach(row => {
        const status = getLicenseStatus(row.expiryDate);
        
        const tr = document.createElement('tr');
        tr.className = 'data-row';
        tr.setAttribute('data-status', status.status.toLowerCase().replace(' ', '-'));
        
        tr.innerHTML = `
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-industry text-amber-600"></i>
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900">${row.establishment}</div>
                <div class="text-sm text-gray-500">Wood Processing Plant</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.location}</td>
          <td class="px-6 py-4 text-sm font-mono text-gray-900">${row.permitNumber}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.dateApproved}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.expiryDate}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.owner}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${row.dataProvider}</td>
          <td class="px-6 py-4">
            <span class="${status.class} inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white">
              <i class="fas ${status.status === 'Active' ? 'fa-check-circle' : status.status === 'Expiring Soon' ? 'fa-clock' : 'fa-times-circle'} mr-1"></i>
              ${status.status}
            </span>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    function calculateStats() {
      // Use sample data for calculation if no live data
      const sampleData = [
        {expiryDate: 'March 15, 2029'},
        {expiryDate: 'July 20, 2028'},
        {expiryDate: 'April 10, 2025'},
        {expiryDate: 'November 5, 2030'},
        {expiryDate: 'September 12, 2027'},
        {expiryDate: 'January 15, 2023'}
      ];
      
      const dataToUse = allData.length > 0 ? allData : sampleData;
      const total = dataToUse.length;
      let active = 0;
      let expiring = 0;
      let expired = 0;

      dataToUse.forEach(row => {
        const status = getLicenseStatus(row.expiryDate);
        if (status.status === 'Active') {
          active++;
        } else if (status.status === 'Expiring Soon') {
          expiring++;
        } else if (status.status === 'Expired') {
          expired++;
        }
      });

      document.getElementById('totalLicenses').textContent = total;
      document.getElementById('activeLicenses').textContent = active;
      document.getElementById('expiringSoon').textContent = expiring;
      document.getElementById('expiredLicenses').textContent = expired;
      document.getElementById('totalHolders').textContent = total;

      // Update status text
      const activePercentage = total > 0 ? Math.round((active / total) * 100) : 0;
      document.getElementById('totalLicensesChange').innerHTML = `<i class="fas fa-arrow-up"></i> ${activePercentage}% Active`;
      document.getElementById('activeLicensesText').textContent = expired > 0 ? `${expired} expired permits` : 'Currently valid';
    }

    function initializeSearch() {
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          const matchesSearch = text.includes(searchTerm);
          const matchesFilter = currentFilter === 'all' || row.getAttribute('data-status') === currentFilter;
          
          if (matchesSearch && matchesFilter) {
            row.style.display = '';
            row.classList.add('animate-fade-in');
          } else {
            row.style.display = 'none';
          }
        });
      });
    }

    function filterTable(filter) {
      currentFilter = filter;
      const rows = document.querySelectorAll('#tableBody tr');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchesSearch = searchTerm === '' || text.includes(searchTerm);
        const matchesFilter = filter === 'all' || row.getAttribute('data-status') === filter;
        
        if (matchesSearch && matchesFilter) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-blue-300');
      });
      event.target.classList.add('ring-2', 'ring-blue-300');
    }

    function exportData() {
      // Sample WPP data for export
      const sampleData = [
        {establishment: 'Davao Wood Processing Corp.', location: 'San Roque, New Corella, Davao del Norte', permitNumber: 'DENRXI-2A-WPP01-R-03152029', dateApproved: 'March 15, 2024', expiryDate: 'March 15, 2029', owner: 'Roberto Martinez', dataProvider: 'Carmalyn C. Nesperos / RPS-LPU'},
        {establishment: 'New Corella Plywood Manufacturing', location: 'Poblacion, New Corella, Davao del Norte', permitNumber: 'DENRXI-2A-WPP02-R-07202028', dateApproved: 'July 20, 2023', expiryDate: 'July 20, 2028', owner: 'Maria Santos', dataProvider: 'Carmalyn C. Nesperos / RPS-LPU'},
        {establishment: 'Mountain View Timber Processing', location: 'Cabcab, New Corella, Davao del Norte', permitNumber: 'DENRXI-2A-WPP03-R-04102025', dateApproved: 'April 10, 2020', expiryDate: 'April 10, 2025', owner: 'Juan dela Cruz', dataProvider: 'Carmalyn C. Nesperos / RPS-LPU'},
        {establishment: 'Golden Wood Industries', location: 'Mesaoy, New Corella, Davao del Norte', permitNumber: 'DENRXI-2A-WPP04-R-11052030', dateApproved: 'November 5, 2025', expiryDate: 'November 5, 2030', owner: 'Ana Reyes', dataProvider: 'Carmalyn C. Nesperos / RPS-LPU'},
        {establishment: 'Pacific Lumber Mills', location: 'San Isidro, New Corella, Davao del Norte', permitNumber: 'DENRXI-2A-WPP05-R-09122027', dateApproved: 'September 12, 2022', expiryDate: 'September 12, 2027', owner: 'Carlos Garcia', dataProvider: 'Carmalyn C. Nesperos / RPS-LPU'},
        {establishment: 'Sunrise Wood Processing', location: 'Tagum Road, New Corella, Davao del Norte', permitNumber: 'DENRXI-2A-WPP06-R-01152023', dateApproved: 'January 15, 2018', expiryDate: 'January 15, 2023', owner: 'Elena Rodriguez', dataProvider: 'Carmalyn C. Nesperos / RPS-LPU'}
      ];

      const dataToExport = allData.length > 0 ? allData : sampleData;
      const headers = ['Establishment', 'Location/Address', 'Permit Number', 'Date Approved', 'Expiry Date', 'Owner/Representative', 'Data Provider', 'Status'];
      const rows = dataToExport.map(row => {
        const status = getLicenseStatus(row.expiryDate);
        return [
          row.establishment,
          row.location,
          row.permitNumber,
          row.dateApproved,
          row.expiryDate,
          row.owner,
          row.dataProvider,
          status.status
        ];
      });

      const csvContent = [headers, ...rows].map(row => 
        row.map(cell => `"${cell}"`).join(',')
      ).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'wpp-permits-' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Add smooth scrolling and animations
    document.querySelectorAll('.stat-card, .table-container').forEach(el => {
      el.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
      });
      
      el.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a41946b3fbfedb',t:'MTc1NDM3Mzg4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

  <script>
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.onkeydown = function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0))) {
      return false;
    }
  };
</script>
</html>

