<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Monitoring Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF and html2canvas (html2canvas is not used for full page rendering here,
     but kept in case you want snapshot options) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
  h1 { text-align: center; margin-bottom: 10px; }
  .controls { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .left-controls { display:flex; gap:12px; align-items:center; }
  .search-box { margin-bottom: 10px; padding: 8px; width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 4px; }
  .month-nav { text-align: center; margin: 15px 0; font-size: 18px; display:flex; align-items:center; gap:10px; }
  .month-nav button, .btn { padding: 6px 12px; border: none; background: #007BFF; color: white; border-radius: 4px; cursor: pointer; }
  .month-nav button:hover, .btn:hover { background: #0056b3; }
  table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; font-size: 14px; }
  th { background-color: #007BFF; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  img { max-width: 100px; max-height: 80px; cursor: pointer; border-radius: 4px; }
  tfoot td { font-weight: bold; background: #e9ecef; }
  .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
  .chart-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 300px; display: flex; align-items: center; justify-content: center; }
  .chart-container canvas { max-width: 100%; max-height: 100%; }
  .right-align { text-align: right; }
</style>
</head>
<body>

<h1>Forest Products Transport<br>Monitoring Dashboard<br> -Km.48-</h1>

<div class="controls">
  <div class="left-controls">
    <input type="text" id="searchInput" class="search-box" placeholder="Search records..." onkeyup="filterTable()">
    <div class="month-nav">
      <button onclick="changeMonth(-1)">← Prev</button>
      <span id="monthLabel"></span>
      <button onclick="changeMonth(1)">Next →</button>
    </div>
  </div>

  <div>
    <button class="btn" onclick="generatePDF()">Generate PDF Report (current month)</button>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
  <tfoot id="tableFooter"></tfoot>
</table>

<div class="charts">
  <div class="chart-container"><canvas id="chartKind"></canvas></div>
  <div class="chart-container"><canvas id="chartSpecies"></canvas></div>
  <div class="chart-container"><canvas id="chartTimeline"></canvas></div>
</div>

<script>
/* ---------- CONFIG ---------- */
const DATA_URL = "https://script.google.com/macros/s/AKfycbyYReWmhvUY-ECqMaSEP2oNft1GzfjK01du-hNdUk_fn5KOaymGcebSDF0KREBzMJzvNQ/exec";

/* ---------- STATE ---------- */
let allData = [];
let currentMonthIndex = 0;
let monthList = [];

let kindChart, speciesChart, timelineChart;

/* ---------- HELPERS ---------- */

function convertDriveLink(url) {
  if (!url) return "";
  // common drive patterns -> direct view
  if (url.includes("open?id=")) return url.replace("open?id=", "uc?export=view&id=");
  const match = url.match(/\/d\/(.*?)\//);
  if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  return url;
}

// Date-only formatter
function formatDate(value) {
  let d;
  if (!isNaN(value) && value > 1000 && value < 60000) {
    d = new Date((value - 25569) * 86400 * 1000);
  } else {
    d = new Date(value);
  }
  if (isNaN(d)) return value || "";
  return d.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: '2-digit'
  }).toUpperCase();
}

// Date + time formatter for Time Stamp
function formatDateTime(value) {
  let d;
  if (!isNaN(value) && value > 1000 && value < 60000) {
    d = new Date((value - 25569) * 86400 * 1000);
  } else {
    d = new Date(value);
  }
  if (isNaN(d)) return value || "";
  return d.toLocaleString('en-US', {
    year: 'numeric',
    month: 'short',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  }).toUpperCase();
}

function formatNumber(value, decimals = 2) {
  if (isNaN(Number(value))) return value || "";
  return Number(value).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

/* fetches an image URL and returns a base64 dataURL (or throws) */
async function urlToDataURL(url) {
  if (!url) throw new Error("No URL");
  // try to fetch (beware of CORS)
  const response = await fetch(url, { mode: 'cors' });
  if (!response.ok) throw new Error("Failed to fetch image: " + response.status);
  const blob = await response.blob();
  return await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

/* ---------- DATA LOAD ---------- */
fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    // normalize keys to lowercase trimmed
    allData = data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => obj[k.trim().toLowerCase()] = row[k]);
      return obj;
    });

    // find first key that includes 'date' to build months
    const dateKey = Object.keys(allData[0] || {}).find(k => k.includes("date")) || Object.keys(allData[0] || {})[0];
    monthList = [...new Set(allData.map(r => {
      const d = new Date(r[dateKey]);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }))].sort();

    const now = new Date();
    const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    currentMonthIndex = monthList.indexOf(currentMonthStr);
    if (currentMonthIndex === -1) currentMonthIndex = monthList.length - 1;

    renderTableAndCharts();
  })
  .catch(err => {
    console.error("Failed to load data", err);
    alert("Failed to load data. See console for details.");
  });

/* ---------- RENDER TABLE & CHARTS ---------- */
function renderTableAndCharts() {
  if (!allData.length) return;
  const headers = Object.keys(allData[0]);
  const tableHeader = document.getElementById("tableHeader");
  const tableBody = document.getElementById("tableBody");
  const tableFooter = document.getElementById("tableFooter");
  tableHeader.innerHTML = "";
  tableBody.innerHTML = "";
  tableFooter.innerHTML = "";

  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h.toUpperCase();
    tableHeader.appendChild(th);
  });

  const month = monthList[currentMonthIndex];
  document.getElementById("monthLabel").textContent = formatMonthLabel(month).toUpperCase();

  const dateKey = headers.find(k => k.toLowerCase().includes("date"));
  const cuKey = headers.find(k => k.toLowerCase().includes("cu.m"));
  const bdKey = headers.find(k => k.toLowerCase().includes("bd.ft"));
  const piecesKey = headers.find(k => k.toLowerCase().includes("pieces"));
  const kindKey = headers.find(k => k.toLowerCase().includes("kind"));
  const speciesKey = headers.find(k => k.toLowerCase().includes("species"));

  let totalCu = 0, totalBd = 0, totalPieces = 0;
  let kindCounts = {}, speciesCounts = {}, dailyCounts = {};

  const filteredData = allData.filter(row => {
    const d = new Date(row[dateKey]);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === month;
  });

  filteredData.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const key = h.trim().toLowerCase();
      const td = document.createElement("td");
      if (key.includes("photo")) {
        const url = row[key];
        if (url) {
          const img = document.createElement("img");
          img.src = convertDriveLink(url);
          img.loading = "lazy";
          img.onclick = () => window.open(url, "_blank");
          td.appendChild(img);
        }
      } else if (key.includes("timestamp")) {
        td.textContent = formatDateTime(row[key]);
      } else if (key.includes("date issued") || key.includes("expiry date") ) {
        td.textContent = formatDate(row[key]); // ensure date only for these
      } else if (key === "date" || key.includes("date/ time")) {
        td.textContent = formatDate(row[key]);
      } else {
        td.textContent = row[key] || "";
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);

    totalCu += parseFloat(row[cuKey]) || 0;
    totalBd += parseFloat(row[bdKey]) || 0;
    totalPieces += parseInt(row[piecesKey]) || 0;

    kindCounts[row[kindKey]] = (kindCounts[row[kindKey]] || 0) + 1;
    speciesCounts[row[speciesKey]] = (speciesCounts[row[speciesKey]] || 0) + 1;

    const dayLabel = new Date(row[dateKey]).toLocaleDateString();
    dailyCounts[dayLabel] = (dailyCounts[dayLabel] || 0) + 1;
  });

  // FOOTER with number formatting (commas if thousands)
  const footerRow = document.createElement("tr");
  headers.forEach(h => {
    const key = h.toLowerCase();
    const td = document.createElement("td");
    if (key.includes("cu.m")) {
      td.textContent = formatNumber(totalCu) + " CU.M.";
      td.classList.add('right-align');
    } else if (key.includes("bd.ft")) {
      td.textContent = formatNumber(totalBd) + " BD.FT";
      td.classList.add('right-align');
    } else if (key.includes("pieces")) {
      td.textContent = formatNumber(totalPieces, 0) + " PIECES";
      td.classList.add('right-align');
    } else if (headers.indexOf(h) === 0) {
      td.textContent = "TOTAL:";
    } else {
      td.textContent = "";
    }
    footerRow.appendChild(td);
  });
  tableFooter.appendChild(footerRow);

  renderCharts(kindCounts, speciesCounts, dailyCounts);
}

/* ---------- CHARTS ---------- */
function renderCharts(kindCounts, speciesCounts, dailyCounts) {
  if (kindChart) kindChart.destroy();
  if (speciesChart) speciesChart.destroy();
  if (timelineChart) timelineChart.destroy();

  kindChart = new Chart(document.getElementById("chartKind"), {
    type: "bar",
    data: { labels: Object.keys(kindCounts), datasets: [{ label: "Kind", data: Object.values(kindCounts), backgroundColor: "#007BFF" }] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  speciesChart = new Chart(document.getElementById("chartSpecies"), {
    type: "pie",
    data: { labels: Object.keys(speciesCounts), datasets: [{ label: "Species", data: Object.values(speciesCounts), backgroundColor: ["#28a745","#ffc107","#17a2b8","#dc3545","#6f42c1","#20c997","#fd7e14","#6610f2"] }] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  timelineChart = new Chart(document.getElementById("chartTimeline"), {
    type: "line",
    data: { labels: Object.keys(dailyCounts), datasets: [{ label: "Daily Trend", data: Object.values(dailyCounts), fill: false, borderColor: "#17a2b8" }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

/* ---------- NAV ---------- */
function changeMonth(step) {
  currentMonthIndex += step;
  if (currentMonthIndex < 0) currentMonthIndex = monthList.length - 1;
  if (currentMonthIndex >= monthList.length) currentMonthIndex = 0;
  renderTableAndCharts();
}
function formatMonthLabel(monthStr) {
  const [year, month] = monthStr.split("-");
  return `${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} ${year}`;
}

/* ---------- SEARCH ---------- */
function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tbody tr");
  rows.forEach(row => {
    const cells = Array.from(row.getElementsByTagName("td"));
    row.style.display = cells.some(cell => cell.textContent.toLowerCase().includes(searchValue)) ? "" : "none";
  });
}

/* ---------- PDF GENERATION ---------- */
/*
  Behavior:
  - Generates a PDF in LETTER size (inches).
  - One page per record (you can change this layout).
  - Images are embedded at 3 x 5 inches (width x height).
  - If image fetch fails (CORS or 404), the page is still generated with a placeholder message.
*/
async function generatePDF() {
  if (!allData.length) { alert("No data loaded."); return; }

  const headers = Object.keys(allData[0]);
  const dateKey = headers.find(k => k.toLowerCase().includes("date"));
  const month = monthList[currentMonthIndex];
  const filteredData = allData.filter(row => {
    const d = new Date(row[dateKey]);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === month;
  });

  if (!filteredData.length) { alert("No records for the selected month."); return; }

  // use jsPDF from the UMD build we loaded
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'in', format: 'legal' }); // unit: inches

  /// Title page
doc.setFontSize(14);
doc.text(`Forest Products Transport Report - ${formatMonthLabel(month).toUpperCase()}`, 1.5, 0.6);
doc.setFontSize(10);
doc.text(`Generated: ${new Date().toLocaleString('en-US')}`, 0.5, 0.9);
doc.text(`Records included: ${filteredData.length}`, 0.5, 1.2);

// Add this line so records start on a new page



  let pageIndex = 0;
  for (const record of filteredData) {
    if (pageIndex > 0 || doc.getNumberOfPages() > 1) doc.addPage();
    // header
    doc.setFontSize(11);
    doc.text(`Record #${pageIndex + 1}`, 0.5, 0.6);
    doc.setFontSize(9);

    // left column text starting at x=0.5, y=0.9 and increment y per field
    let y = 1.5;
    const leftX = 0.5;
    const rightX = 5.0; // place photo near right side (fits 3 in width on letter)

    // place fields: we will print key: value for non-photo fields
    for (const k of headers) {
      const key = k.trim().toLowerCase();
      // skip photo fields for now
      if (key.includes("photo")) continue;

      let displayValue = record[key] || "";
      if (key.includes("timestamp")) displayValue = formatDateTime(displayValue);
      else if (key.includes("date issued") || key.includes("expiry date")) displayValue = formatDate(displayValue);
      else if (key === "date" || key.includes("date/ time")) displayValue = formatDate(displayValue);

      // write only until we approach bottom of page (keep margin)
      if (y > 10.5) {
        doc.addPage();
        y = 0.6;
      }
      doc.text(`${k.toUpperCase()}: ${String(displayValue)}`, leftX, y);
      y += 0.25;
    }

    // find photo fields in record
    const photoKeys = Object.keys(record).filter(k => k.includes("photo") && record[k]);
    // convert first photo to dataURL and draw at 3x5 inches
    if (photoKeys.length) {
      // draw up to 2 photos stacked if present
      let photoY = 0.6; // starting y position for first photo
      for (let i = 0; i < photoKeys.length && i < 2; i++) {
        const originalUrl = record[photoKeys[i]];
        const imageUrl = convertDriveLink(originalUrl);
        try {
          const dataUrl = await urlToDataURL(imageUrl);
          // draw image at rightX, photoY with 3 x 5 (in)
          doc.addImage(dataUrl, 'JPEG', rightX, photoY, 3.0, 5.0);
        } catch (err) {
          console.warn("Image embed failed for", imageUrl, err);
          doc.setFontSize(9);
          doc.text(`(Image failed to load: ${imageUrl})`, rightX, photoY + 0.2);
        }
        photoY += 5.2; // leave a gap after the image
      }
    } else {
      // no photo: show message in photo area
      doc.setFontSize(9);
      doc.text("(No photo available)", rightX, 1.0);
    }

    pageIndex++;
  }

  // save the PDF
  doc.save(`Report_${formatMonthLabel(month).replace(/\s+/g,'_')}.pdf`);
}

/* ---------- END ---------- */
</script>

</body>
</html>
