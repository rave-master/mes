<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monitoring Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
  h1 { text-align: center; margin-bottom: 10px; }
  .search-box { margin-bottom: 10px; padding: 8px; width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 4px; }
  .month-nav { text-align: center; margin: 15px 0; font-size: 18px; }
  .month-nav button, #downloadPDF { padding: 6px 12px; margin: 0 10px; border: none; background: #007BFF; color: white; border-radius: 4px; cursor: pointer; }
  .month-nav button:hover, #downloadPDF:hover { background: #0056b3; }
  table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; font-size: 14px; }
  th { background-color: #007BFF; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  img { width: 144px; height: 240px; object-fit: cover; cursor: pointer; border-radius: 4px; } /* 3x5 inches at ~48px/inch */
  tfoot td { font-weight: bold; background: #e9ecef; }
  .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
  .chart-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 300px; display: flex; align-items: center; justify-content: center; }
  .chart-container canvas { max-width: 100%; max-height: 100%; }
</style>
</head>
<body>

<h1>Forest Products Transport<br>Monitoring Dashboard<br> -Km.48-</h1>

<input type="text" id="searchInput" class="search-box" placeholder="Search records..." onkeyup="filterTable()">

<div class="month-nav">
  <button onclick="changeMonth(-1)">← Prev</button>
  <span id="monthLabel"></span>
  <button onclick="changeMonth(1)">Next →</button>
  <button id="downloadPDF">Download PDF</button>
</div>

<table id="dataTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
  <tfoot id="tableFooter"></tfoot>
</table>

<div class="charts">
  <div class="chart-container"><canvas id="chartKind"></canvas></div>
  <div class="chart-container"><canvas id="chartSpecies"></canvas></div>
  <div class="chart-container"><canvas id="chartTimeline"></canvas></div>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbyYReWmhvUY-ECqMaSEP2oNft1GzfjK01du-hNdUk_fn5KOaymGcebSDF0KREBzMJzvNQ/exec";
let allData = [];
let currentMonthIndex = 0;
let monthList = [];
let kindChart, speciesChart, timelineChart;

function convertDriveLink(url) {
  if (!url) return "";
  if (url.includes("open?id=")) return url.replace("open?id=", "uc?export=view&id=");
  const match = url.match(/\/d\/(.*?)\//);
  if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  return url;
}

function formatDate(value) {
  let d = new Date(value);
  if (isNaN(d)) return value;
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' }).toUpperCase();
}

function formatDateTime(value) {
  let d = new Date(value);
  if (isNaN(d)) return value;
  return d.toLocaleString('en-US', { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true }).toUpperCase();
}

function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    allData = data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => obj[k.trim().toLowerCase()] = row[k]);
      return obj;
    });

    const dateKey = Object.keys(allData[0]).find(k => k.includes("date"));
    monthList = [...new Set(allData.map(r => {
      const d = new Date(r[dateKey]);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`;
    }))].sort();

    const now = new Date();
    const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}`;
    currentMonthIndex = monthList.indexOf(currentMonthStr);
    if (currentMonthIndex === -1) currentMonthIndex = monthList.length - 1;

    renderTableAndCharts();
  });

function renderTableAndCharts() {
  const headers = Object.keys(allData[0]);
  const tableHeader = document.getElementById("tableHeader");
  const tableBody = document.getElementById("tableBody");
  const tableFooter = document.getElementById("tableFooter");
  tableHeader.innerHTML = "";
  tableBody.innerHTML = "";
  tableFooter.innerHTML = "";

  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h.toUpperCase();
    tableHeader.appendChild(th);
  });

  const month = monthList[currentMonthIndex];
  document.getElementById("monthLabel").textContent = formatMonthLabel(month).toUpperCase();

  const dateKey = headers.find(k => k.toLowerCase().includes("date"));
  const cuKey = headers.find(k => k.toLowerCase().includes("cu.m"));
  const bdKey = headers.find(k => k.toLowerCase().includes("bd.ft"));
  const piecesKey = headers.find(k => k.toLowerCase().includes("pieces"));
  const kindKey = headers.find(k => k.toLowerCase().includes("kind"));
  const speciesKey = headers.find(k => k.toLowerCase().includes("species"));

  let totalCu = 0, totalBd = 0, totalPieces = 0;
  let kindCounts = {}, speciesCounts = {}, dailyCounts = {};

  const filteredData = allData.filter(row => {
    const d = new Date(row[dateKey]);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}` === month;
  });

  filteredData.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const key = h.trim().toLowerCase();
      const td = document.createElement("td");
      if (key.includes("photo")) {
        const url = row[key];
        if (url) {
          const img = document.createElement("img");
          img.src = convertDriveLink(url);
          img.loading = "lazy";
          img.onclick = () => window.open(url, "_blank");
          td.appendChild(img);
        }
      } else if (key.includes("timestamp")) {
        td.textContent = formatDateTime(row[key]);
      } else if (key === "date issued" || key === "expiry date" || key === "date") {
        td.textContent = formatDate(row[key]);
      } else {
        td.textContent = row[key] || "";
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);

    totalCu += parseFloat(row[cuKey]) || 0;
    totalBd += parseFloat(row[bdKey]) || 0;
    totalPieces += parseInt(row[piecesKey]) || 0;

    kindCounts[row[kindKey]] = (kindCounts[row[kindKey]] || 0) + 1;
    speciesCounts[row[speciesKey]] = (speciesCounts[row[speciesKey]] || 0) + 1;

    const dayLabel = new Date(row[dateKey]).toLocaleDateString();
    dailyCounts[dayLabel] = (dailyCounts[dayLabel] || 0) + 1;
  });

  const footerRow = document.createElement("tr");
  headers.forEach(h => {
    const key = h.toLowerCase();
    const td = document.createElement("td");
    if (key.includes("cu.m")) {
      td.textContent = numberWithCommas(totalCu.toFixed(2)) + " CU.M.";
    } else if (key.includes("bd.ft")) {
      td.textContent = numberWithCommas(totalBd.toFixed(2)) + " BD.FT";
    } else if (key.includes("pieces")) {
      td.textContent = numberWithCommas(totalPieces) + " PIECES";
    } else if (headers.indexOf(h) === 0) {
      td.textContent = "TOTAL:";
    } else {
      td.textContent = "";
    }
    footerRow.appendChild(td);
  });
  tableFooter.appendChild(footerRow);

  renderCharts(kindCounts, speciesCounts, dailyCounts);
}

function renderCharts(kindCounts, speciesCounts, dailyCounts) {
  if (kindChart) kindChart.destroy();
  if (speciesChart) speciesChart.destroy();
  if (timelineChart) timelineChart.destroy();

  kindChart = new Chart(document.getElementById("chartKind"), {
    type: "bar",
    data: {
      labels: Object.keys(kindCounts),
      datasets: [{ label: "Kind", data: Object.values(kindCounts), backgroundColor: "#007BFF" }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  speciesChart = new Chart(document.getElementById("chartSpecies"), {
    type: "pie",
    data: {
      labels: Object.keys(speciesCounts),
      datasets: [{ label: "Species", data: Object.values(speciesCounts), backgroundColor: ["#28a745","#ffc107","#17a2b8","#dc3545","#6f42c1","#20c997","#fd7e14","#6610f2"] }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  timelineChart = new Chart(document.getElementById("chartTimeline"), {
    type: "line",
    data: {
      labels: Object.keys(dailyCounts),
      datasets: [{ label: "Daily Trend", data: Object.values(dailyCounts), fill: false, borderColor: "#17a2b8" }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function changeMonth(step) {
  currentMonthIndex += step;
  if (currentMonthIndex < 0) currentMonthIndex = monthList.length - 1;
  if (currentMonthIndex >= monthList.length) currentMonthIndex = 0;
  renderTableAndCharts();
}

function formatMonthLabel(monthStr) {
  const [year, month] = monthStr.split("-");
  return `${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} ${year}`;
}

function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tbody tr");
  rows.forEach(row => {
    const cells = Array.from(row.getElementsByTagName("td"));
    row.style.display = cells.some(cell => cell.textContent.toLowerCase().includes(searchValue)) ? "" : "none";
  });
}

// PDF Export
document.getElementById("downloadPDF").addEventListener("click", function () {
  const { jsPDF } = window.jspdf;
  const tableElement = document.getElementById("dataTable");

  html2canvas(tableElement, { scale: 2, useCORS: true }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("l", "pt", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 40;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 20, 20, imgWidth, imgHeight);
    pdf.save("Forest_Report.pdf");
  });
});
</script>

</body>
</html>
